# Natter Web 日志持久化功能

## 功能概述

Natter Web 现在支持服务日志的持久化存储，解决了之前容器重启后日志丢失的问题。

## 主要特性

### 1. 日志文件持久化

- 每个服务的日志都会保存到独立的文件中
- 日志文件命名格式：`service_{服务ID}.log`
- 存储位置：`/app/logs/`目录

### 2. 自动日志管理

- **启动时加载**：服务启动时自动加载历史日志
- **实时保存**：运行过程中的日志实时写入文件
- **错误记录**：特殊错误信息会立即保存到文件
- **清理功能**：清空日志时同时清空内存和文件
- **删除清理**：删除服务时自动删除对应的日志文件

### 3. Docker容器支持

- 通过挂载 `/app/logs` 目录实现持久化
- 支持容器重启后日志恢复
- 配置了适当的文件权限

## 目录结构

```
/app/
├── data/           # 配置数据目录
├── logs/           # 日志文件目录 (新增)
│   ├── service_1234567890.log
│   ├── service_1234567891.log
│   └── ...
└── web/            # Web应用程序
```

## 环境变量

- `LOGS_DIR`: 日志存储目录路径（默认：`/app/logs`）
- `DATA_DIR`: 数据存储目录路径（默认：`/app/data`）

## Docker 部署配置

### 1. docker-compose.yml

```yaml
volumes:
  - ./data:/app/data  # 数据持久化
  - ./logs:/app/logs  # 日志持久化 (新增)

environment:
  - LOGS_DIR=/app/logs  # 日志目录环境变量 (新增)
```

### 2. Docker Run 命令

```bash
docker run -d \
  -v /path/to/logs:/app/logs \    # 日志目录挂载 (新增)
  -v /path/to/data:/app/data \    # 数据目录挂载
  -e LOGS_DIR=/app/logs \         # 日志目录环境变量 (新增)
  natter-web:latest
```

## 日志功能说明

### 1. 日志保留策略

- 内存中最多保留100行最新日志（用于Web界面显示）
- 文件中保存完整的日志历史
- 不设置日志文件大小限制（由用户或系统管理）

### 2. 日志内容

- Natter程序的标准输出和错误输出
- 服务状态变更记录
- 错误诊断信息
- NAT类型推断结果

### 3. 错误处理

- 日志文件读写错误会在控制台输出错误信息
- 不会因为日志文件问题影响服务正常运行
- 优雅降级：文件操作失败时仍保留内存日志

## 使用建议

### 1. 日志清理

- 定期清理过大的日志文件
- 可以通过Web界面清空单个服务的日志
- 删除服务时会自动清理对应的日志文件

### 2. 监控建议

- 监控logs目录的磁盘使用情况
- 设置适当的日志轮转策略（可选）

### 3. 备份建议

- 将logs目录包含在备份计划中
- 重要的日志信息可以定期归档

## 技术实现

### 1. 核心类修改

- `NatterService`: 添加日志文件路径和读写方法
- 新增 `_load_logs()` 方法：启动时加载历史日志
- 新增 `_save_logs()` 方法：实时保存日志到文件
- 修改 `clear_logs()` 方法：同时清空内存和文件
- 修改 `_capture_output()` 方法：每行日志都保存到文件

### 2. 目录管理

- 自动创建logs目录
- 设置适当的文件权限
- 支持环境变量配置路径

### 3. 错误容错

- 文件操作异常不影响服务运行
- 详细的错误日志记录
- 优雅的错误处理

## 兼容性

- 向后兼容：现有的服务不受影响
- 升级平滑：现有数据和配置保持不变
- 可选功能：日志持久化不影响核心功能

## 版本信息

- 添加版本：v1.0.5
- 更新日期：2025-05-29
- 贡献者：Await Developer
