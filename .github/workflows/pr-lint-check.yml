name: PR Code Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**.sh'
      - '**.yml'
      - '**.yaml'
      - '**.json'
      - '**.md'
      - '**.html'
      - '**.css'
      - '**.js'
      - 'Dockerfile'
      - 'requirements.txt'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Check Code Quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£…ä»£ç è´¨é‡æ£€æŸ¥å·¥å…·
          pip install black isort flake8 pylint

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.py
            **/*.sh
            **/*.yml
            **/*.yaml
            **/*.json
            **/*.md
            **/*.html
            **/*.css
            **/*.js
            **/Dockerfile
            **/requirements.txt
          files_ignore: |
            .git/**
            .github/**
            logs/**
            temp/**
            tmp/**
            __pycache__/**
            *.pyc
            .pytest_cache/**

      - name: Check Python code formatting with Black
        if: steps.changed-files.outputs.any_changed == 'true'
        id: black-check
        run: |
          echo "ğŸ” Checking Black formatting for Python files..."

          PYTHON_FILES=""
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" =~ \.py$ ]] && [ -f "$file" ]; then
              PYTHON_FILES="$PYTHON_FILES $file"
            fi
          done

          if [ -n "$PYTHON_FILES" ]; then
            echo "Checking Python files: $PYTHON_FILES"

            BLACK_FAILED=false
            BLACK_OUTPUT=""

            for file in $PYTHON_FILES; do
              echo "Checking: $file"
              if ! black --check --diff "$file" 2>&1; then
                BLACK_FAILED=true
                DIFF=$(black --diff "$file" 2>/dev/null || true)
                if [ -n "$DIFF" ]; then
                  BLACK_OUTPUT="${BLACK_OUTPUT}âŒ File needs formatting: $file\n"
                  BLACK_OUTPUT="${BLACK_OUTPUT}\`\`\`diff\n${DIFF}\n\`\`\`\n\n"
                fi
              else
                echo "âœ… $file is properly formatted"
              fi
            done

            if [ "$BLACK_FAILED" = true ]; then
              echo "black_failed=true" >> $GITHUB_OUTPUT
              echo -e "$BLACK_OUTPUT" > black-report.md
              echo "âŒ Some Python files are not properly formatted."
              echo "Please run: black ."
              exit 1
            else
              echo "black_failed=false" >> $GITHUB_OUTPUT
              echo "âœ… All Python files are properly formatted"
            fi
          else
            echo "black_failed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Python files to check"
          fi

      - name: Check Python imports with isort
        if: steps.changed-files.outputs.any_changed == 'true'
        id: isort-check
        run: |
          echo "ğŸ” Checking import sorting with isort..."

          PYTHON_FILES=""
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" =~ \.py$ ]] && [ -f "$file" ]; then
              PYTHON_FILES="$PYTHON_FILES $file"
            fi
          done

          if [ -n "$PYTHON_FILES" ]; then
            echo "Checking Python files: $PYTHON_FILES"

            ISORT_FAILED=false
            ISORT_OUTPUT=""

            for file in $PYTHON_FILES; do
              echo "Checking: $file"
              if ! isort --check-only --diff "$file" 2>&1; then
                ISORT_FAILED=true
                DIFF=$(isort --diff "$file" 2>/dev/null || true)
                if [ -n "$DIFF" ]; then
                  ISORT_OUTPUT="${ISORT_OUTPUT}âŒ File imports need sorting: $file\n"
                  ISORT_OUTPUT="${ISORT_OUTPUT}\`\`\`diff\n${DIFF}\n\`\`\`\n\n"
                fi
              else
                echo "âœ… $file imports are properly sorted"
              fi
            done

            if [ "$ISORT_FAILED" = true ]; then
              echo "isort_failed=true" >> $GITHUB_OUTPUT
              echo -e "$ISORT_OUTPUT" > isort-report.md
              echo "âŒ Some Python files have unsorted imports."
              echo "Please run: isort ."
              exit 1
            else
              echo "isort_failed=false" >> $GITHUB_OUTPUT
              echo "âœ… All Python imports are properly sorted"
            fi
          else
            echo "isort_failed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Python files to check"
          fi

      - name: Run Flake8 linting
        if: steps.changed-files.outputs.any_changed == 'true'
        id: flake8-check
        run: |
          echo "ğŸ” Running Flake8 linting..."

          PYTHON_FILES=""
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" =~ \.py$ ]] && [ -f "$file" ]; then
              PYTHON_FILES="$PYTHON_FILES $file"
            fi
          done

          if [ -n "$PYTHON_FILES" ]; then
            echo "Linting Python files: $PYTHON_FILES"

            set +e
            FLAKE8_OUTPUT=$(flake8 $PYTHON_FILES --max-line-length=88 --extend-ignore=E203,W503 2>&1)
            FLAKE8_EXIT_CODE=$?
            set -e

            if [ $FLAKE8_EXIT_CODE -ne 0 ]; then
              echo "flake8_failed=true" >> $GITHUB_OUTPUT
              echo "âŒ Flake8 found issues"

              echo "## Flake8 Report" > flake8-report.md
              echo "\`\`\`" >> flake8-report.md
              echo "$FLAKE8_OUTPUT" >> flake8-report.md
              echo "\`\`\`" >> flake8-report.md

              exit 1
            else
              echo "flake8_failed=false" >> $GITHUB_OUTPUT
              echo "âœ… Flake8 check passed"
            fi
          else
            echo "flake8_failed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Python files to check"
          fi

      - name: Debug PR Context
        if: failure()
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Repo: ${{ github.repository }}"
          echo "Event Name: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"

      - name: Comment PR with results
        if: failure()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let comment = '## ğŸš¨ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥\n\n';

            // è¯»å– Black æŠ¥å‘Š
            if (fs.existsSync('black-report.md')) {
              const blackReport = fs.readFileSync('black-report.md', 'utf8');
              comment += '### Black æ ¼å¼åŒ–é—®é¢˜\n\n';
              comment += blackReport;
              comment += '\n**ä¿®å¤å‘½ä»¤:**\n```bash\nblack .\n```\n\n';
            }

            // è¯»å– isort æŠ¥å‘Š
            if (fs.existsSync('isort-report.md')) {
              const isortReport = fs.readFileSync('isort-report.md', 'utf8');
              comment += '### Import æ’åºé—®é¢˜\n\n';
              comment += isortReport;
              comment += '\n**ä¿®å¤å‘½ä»¤:**\n```bash\nisort .\n```\n\n';
            }

            // è¯»å– Flake8 æŠ¥å‘Š
            if (fs.existsSync('flake8-report.md')) {
              const flake8Report = fs.readFileSync('flake8-report.md', 'utf8');
              comment += '### Flake8 ä»£ç è´¨é‡é—®é¢˜\n\n';
              comment += flake8Report;
            }

            comment += '\n---\n';
            comment += 'ğŸ’¡ **æç¤º**: åœ¨æœ¬åœ°è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è‡ªåŠ¨ä¿®å¤å¤§éƒ¨åˆ†é—®é¢˜:\n';
            comment += '```bash\n';
            comment += '# å®‰è£…å·¥å…·\n';
            comment += 'pip install black isort flake8\n\n';
            comment += '# è‡ªåŠ¨ä¿®å¤æ ¼å¼\n';
            comment += 'black .          # ä¿®å¤ä»£ç æ ¼å¼\n';
            comment += 'isort .          # ä¿®å¤importæ’åº\n';
            comment += 'flake8 .         # æ£€æŸ¥ä»£ç è´¨é‡\n';
            comment += '```\n';

            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰æœºå™¨äººè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥')
            );

            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Success comment
        if: success() && steps.changed-files.outputs.any_changed == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰å¤±è´¥çš„è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥')
            );

            if (botComment) {
              // å¦‚æœä¹‹å‰æœ‰å¤±è´¥è¯„è®ºï¼Œæ›´æ–°ä¸ºæˆåŠŸ
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: '## âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡\n\næ‰€æœ‰æ–‡ä»¶æ ¼å¼æ­£ç¡®ä¸”é€šè¿‡äº†ä»£ç è´¨é‡æ£€æŸ¥ï¼'
              });
            }