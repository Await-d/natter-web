# 任务文档

- [x] 1. 创建MCP协议处理核心类
  - 文件: web/server.py (在现有文件中添加)
  - 在server.py中添加MCPProtocol类，实现MCP协议的消息解析和路由
  - 支持MCP握手、工具列表、工具调用等核心协议功能
  - 目的: 建立MCP协议处理的基础架构
  - _复用: 现有的JSON处理和错误处理机制_
  - _需求: 需求1.1, 需求1.2_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：MCP协议专家，精通JSON-RPC和协议设计 | 任务：在web/server.py中创建MCPProtocol类，实现MCP协议的消息解析、路由和响应生成，支持握手、工具发现、工具调用等核心功能，需求1.1和1.2 | 限制：不要修改现有的HTTP处理逻辑，使用现有的JSON和错误处理模式，遵循现有代码风格 | _复用：现有的JSON序列化、错误处理和线程安全机制 | _需求：实现需求1.1（MCP协议实现）和1.2（服务信息查询API）中的协议层部分 | 成功标准：MCPProtocol类能正确解析MCP消息，路由到相应处理器，返回符合MCP规范的响应 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 2. 实现MCP工具注册和管理系统
  - 文件: web/server.py (继续在现有文件中添加)
  - 创建MCPToolRegistry类，管理可用工具的注册、发现和调用
  - 实现基于用户权限的工具过滤和访问控制
  - 目的: 提供工具管理的核心基础设施
  - _复用: ServiceGroupManager的权限检查逻辑_
  - _需求: 需求1.2, 需求3_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：系统架构师，精通插件架构和权限管理 | 任务：创建MCPToolRegistry类，实现工具注册、发现和权限控制机制，集成现有的ServiceGroupManager权限系统，需求1.2和3 | 限制：必须复用现有权限检查逻辑，不要重复实现权限管理，保持工具接口简洁 | _复用：ServiceGroupManager类的权限检查方法，现有的用户角色系统 | _需求：实现需求1.2（服务信息查询API）和需求3（身份验证和授权）的工具管理部分 | 成功标准：工具注册系统正常工作，权限控制有效，不同角色用户看到合适的工具列表 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 3. 实现服务管理相关的MCP工具
  - 文件: web/server.py (继续在现有文件中添加)
  - 创建MCPServiceTools类，实现list_services, get_service_status, start_service, stop_service等工具
  - 直接复用现有的NatterService类和running_services字典
  - 目的: 提供服务管理的MCP接口实现
  - _复用: NatterService类的所有方法，running_services全局字典_
  - _需求: 需求2, 需求4_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：后端开发工程师，精通Python和服务管理 | 任务：创建MCPServiceTools类，实现服务管理相关的MCP工具，完全复用现有NatterService类和running_services字典，需求2和4 | 限制：不要修改NatterService类，直接调用现有方法，保持与现有HTTP API的一致性 | _复用：NatterService类的start/stop/restart/get_status方法，running_services字典，现有的服务配置管理 | _需求：实现需求2（服务信息查询API）和需求4（操作管理命令）的具体工具实现 | 成功标准：所有服务管理工具正常工作，与HTTP API行为完全一致，支持相同的参数和返回格式 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 4. 扩展HTTP处理器支持MCP端点
  - 文件: web/server.py (修改现有的NatterHttpHandler类)
  - 在现有NatterHttpHandler类中添加MCP协议的HTTP端点处理
  - 集成现有的认证中间件支持MCP客户端认证
  - 目的: 为MCP协议提供HTTP传输层支持
  - _复用: 现有的_authenticate_token()和_authenticate()方法_
  - _需求: 需求1.1, 需求3.1_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：Web开发工程师，精通HTTP协议和身份验证 | 任务：在NatterHttpHandler类中添加MCP协议的HTTP端点，集成现有认证系统支持MCP客户端，需求1.1和3.1 | 限制：不要破坏现有的HTTP API端点，保持认证逻辑一致性，确保向后兼容 | _复用：现有的_authenticate_token()、_authenticate()、_set_headers()等认证和响应方法 | _需求：实现需求1.1（MCP协议实现）和需求3.1（身份验证和授权）的HTTP传输层 | 成功标准：MCP端点可通过HTTP访问，认证机制正常工作，不影响现有HTTP API功能 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 5. 实现实时状态更新机制
  - 文件: web/server.py (扩展现有的消息队列系统)
  - 扩展现有的message_queue系统支持MCP客户端订阅
  - 创建MCPNotificationManager类管理客户端订阅和通知推送
  - 目的: 为MCP客户端提供实时状态更新功能
  - _复用: 现有的message_queue、queue_message()函数和通知机制_
  - _需求: 需求5_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：实时系统开发工程师，精通事件驱动架构和通知系统 | 任务：扩展现有消息队列系统创建MCPNotificationManager类，为MCP客户端提供实时状态更新订阅功能，需求5 | 限制：不要修改现有的IYUU推送逻辑，保持消息队列的现有行为，确保性能不受影响 | _复用：现有的message_queue、queue_message()函数、消息批处理逻辑 | _需求：实现需求5（实时状态更新）的完整订阅和推送机制 | 成功标准：MCP客户端能订阅状态更新，及时收到服务状态变化通知，不影响现有推送功能 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 6. 添加MCP配置管理和环境变量支持
  - 文件: web/server.py (在全局配置区域添加)
  - 添加MCP相关的环境变量配置（启用/禁用、端口、超时等）
  - 扩展现有的JSON配置文件支持MCP客户端权限设置
  - 目的: 提供MCP服务的配置管理能力
  - _复用: 现有的环境变量处理模式和JSON配置加载机制_
  - _需求: 需求3, 非功能性需求_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：DevOps工程师，精通配置管理和环境变量 | 任务：添加MCP相关环境变量和JSON配置支持，扩展现有配置管理机制，需求3和非功能性需求 | 限制：遵循现有环境变量命名约定，不要修改现有配置文件结构，保持配置的向后兼容性 | _复用：现有的os.environ.get()模式、DATA_DIR配置、JSON文件加载机制 | _需求：实现需求3（身份验证和授权）的配置部分和非功能性需求的配置管理 | 成功标准：MCP配置正确加载，环境变量生效，配置文件格式保持一致，支持运行时配置更新 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 7. 实现错误处理和日志记录
  - 文件: web/server.py (扩展现有错误处理)
  - 为MCP协议添加专门的错误码和错误处理逻辑
  - 集成现有的日志系统记录MCP操作审计信息
  - 目的: 确保MCP服务的可靠性和可观测性
  - _复用: 现有的错误处理模式和print日志输出_
  - _需求: 所有需求的错误处理部分_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：可靠性工程师，精通错误处理和日志系统 | 任务：为MCP协议实现专门的错误处理和审计日志，集成现有日志模式，覆盖所有需求的错误场景 | 限制：遵循MCP协议的错误响应格式，不要修改现有错误处理逻辑，保持日志格式一致性 | _复用：现有的try-catch模式、print日志输出、错误响应格式 | _需求：实现所有需求中的错误处理和日志记录要求 | 成功标准：MCP错误响应符合协议规范，审计日志完整记录操作，错误信息清晰可操作 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 8. 编写MCP功能的单元测试
  - 文件: 创建新的测试文件 web/test_mcp.py
  - 为所有MCP组件编写单元测试，包括协议处理、工具执行、权限检查
  - 使用Python标准库的unittest模块
  - 目的: 确保MCP功能的质量和回归测试覆盖
  - _复用: 现有的测试模式和数据结构_
  - _需求: 所有功能需求的测试覆盖_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：QA工程师，精通Python单元测试和测试驱动开发 | 任务：为所有MCP组件创建全面的单元测试，使用Python unittest模块，覆盖所有功能需求 | 限制：不要依赖外部测试框架，使用标准库unittest，确保测试隔离和可重复性 | _复用：现有的数据结构、配置文件格式、错误处理模式用于测试用例设计 | _需求：为所有功能需求提供测试覆盖，确保代码质量 | 成功标准：测试覆盖率高，所有关键功能有测试，测试可独立运行且稳定 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 9. 创建MCP客户端示例和文档
  - 文件: 创建新目录 web/mcp_examples/ 和相关文件
  - 编写Python MCP客户端示例代码展示如何连接和使用服务
  - 创建简单的使用文档和API参考
  - 目的: 为用户提供MCP功能的使用指南和示例
  - _复用: 现有的API模式和认证机制作为参考_
  - _需求: 可用性要求中的文档和示例_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：技术文档工程师，精通API文档和示例代码编写 | 任务：创建MCP客户端示例代码和使用文档，展示完整的连接和操作流程，满足可用性要求 | 限制：示例代码必须可执行，文档要简洁明了，不要重复现有CLAUDE.md中的内容 | _复用：现有的认证模式、API调用模式、配置文件格式作为示例参考 | _需求：满足可用性要求中的文档、示例和集成指导需求 | 成功标准：示例代码可直接运行，文档清晰易懂，用户能快速上手MCP功能 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_

- [x] 10. 性能优化和安全加固
  - 文件: web/server.py (优化现有代码)
  - 实现MCP连接池管理和请求速率限制
  - 添加输入验证和安全检查防止滥用
  - 目的: 确保MCP服务满足性能和安全要求
  - _复用: 现有的线程安全机制和认证检查_
  - _需求: 非功能性需求（性能、安全性）_
  - _Prompt: 实现spec mcp-service的任务，首先运行spec-workflow-guide获取工作流指南然后实现任务：角色：安全工程师，精通性能优化和安全防护 | 任务：实现MCP服务的性能优化和安全加固，包括连接管理、速率限制、输入验证，满足非功能性需求 | 限制：不要影响现有性能，保持安全机制一致性，避免过度工程化 | _复用：现有的threading.RLock()机制、认证检查逻辑、输入验证模式 | _需求：满足非功能性需求中的性能、安全性和可靠性要求 | 成功标准：性能指标达到要求，安全检查有效防护，系统稳定可靠 | 在tasks.md中将此任务标记为进行中[-]，完成后标记为已完成[x]_